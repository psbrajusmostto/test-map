<!DOCTYPE html>
<html>
<head>
  <title>Verificar Zona de Influencia</title>
  <style>
    #map { height: 500px; width: 100%; margin-top:10px; }
    #form { margin-bottom: 10px; }
    #resultado { font-weight: bold; margin-top: 5px; }
  </style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCZHevEztqrlkvoZq2URteV8fTBk4u5k0c&libraries=geometry&callback=initMap" async defer></script>
</head>
<body>
  <h3>Verificar Zona de Influencia de Depósitos</h3>

  <div id="form">
    <input type="text" id="direccion" placeholder="Ingrese dirección" size="50">
    <button onclick="verificarDireccion()">Verificar</button>
  </div>

  <div id="resultado"></div>
  <div id="map"></div>

  <script>
    let map;
    let geocoder;
    let marker;
    let circuloActual = null;

    // Lista de depósitos
    const depositos = [
      { nombre: "Depósito Central", lat: -34.6037, lng: -58.3816, radio: 20000 },
      { nombre: "Depósito Norte", lat: -34.5400, lng: -58.7000, radio: 3000 },
      { nombre: "Depósito Sur", lat: -34.7000, lng: -58.4000, radio: 4000 },
      { nombre: "Gualeguaychu", lat: -33.7000, lng: -58.4000, radio: 200000 }
    ];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 10,
        center: { lat: -34.6037, lng: -58.3816 }
      });

      geocoder = new google.maps.Geocoder();

      // Dibujar solo marcadores
      depositos.forEach(dep => {
        new google.maps.Marker({
          position: { lat: dep.lat, lng: dep.lng },
          map: map,
          title: dep.nombre
        });
      });
    }

    function verificarDireccion() {
      const direccion = document.getElementById("direccion").value;
      if (!direccion) return alert("Ingrese una dirección");

      geocoder.geocode({ address: direccion }, (results, status) => {
        if (status === "OK") {
          const pos = results[0].geometry.location;

          // Colocar marcador azul en la dirección buscada
          if (marker) marker.setMap(null);
          marker = new google.maps.Marker({
            map: map,
            position: pos,
            title: "Ubicación buscada",
            icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
          });

          map.setCenter(pos);

          // Verificar si está dentro de alguna zona
          let zonasEncontradas = [];
          depositos.forEach(dep => {
            const distancia = google.maps.geometry.spherical.computeDistanceBetween(
              pos,
              new google.maps.LatLng(dep.lat, dep.lng)
            );
            if (distancia <= dep.radio) {
              zonasEncontradas.push(dep);
            }
          });

          // Mostrar resultado y dibujar círculo de la zona
          if (zonasEncontradas.length > 0) {
            const zona = zonasEncontradas[0]; // Si hay varias, tomamos la primera
            document.getElementById("resultado").innerHTML = 
              `Sí, está dentro de la zona de: <strong>${zona.nombre}</strong>`;

            // Remover círculo anterior si existía
            if (circuloActual) circuloActual.setMap(null);

            // Dibujar círculo de influencia solo de esa zona
            circuloActual = new google.maps.Circle({
              map: map,
              center: { lat: zona.lat, lng: zona.lng },
              radius: zona.radio,
              strokeColor: "#FF0000",
              strokeOpacity: 0.8,
              strokeWeight: 2,
              fillColor: "#FF0000",
              fillOpacity: 0.2
            });

          } else {
            document.getElementById("resultado").innerHTML = "No está dentro de ninguna zona de influencia";

            // Quitar círculo anterior si existía
            if (circuloActual) circuloActual.setMap(null);
          }

        } else {
          alert("Geocoding falló: " + status);
        }
      });
    }
  </script>
</body>
</html>
